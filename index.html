

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Welcome to annolid’s documentation! &mdash; annolid v1.0.1 documentation</title>
  

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/language_data.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="#" class="icon icon-home"> annolid
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <!-- Local TOC -->
              <div class="local-toc"><ul>
<li><a class="reference internal" href="#">Welcome to annolid’s documentation!</a><ul>
<li><a class="reference internal" href="#id41">}</a></li>
</ul>
</li>
<li><a class="reference internal" href="#indices-and-tables">Indices and tables</a></li>
</ul>
</div>
            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="#">annolid</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="#" class="icon icon-home"></a> &raquo;</li>
        
      <li>Welcome to annolid’s documentation!</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="_sources/index.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="welcome-to-annolid-s-documentation">
<h1>Welcome to annolid’s documentation!<a class="headerlink" href="#welcome-to-annolid-s-documentation" title="Permalink to this headline">¶</a></h1>
<p># annolid</p>
<p>[![Annolid Build](<a class="reference external" href="https://github.com/healthonrails/annolid/workflows/Annolid%20CI/badge.svg)](https://github.com/healthonrails/annolid/actions">https://github.com/healthonrails/annolid/workflows/Annolid%20CI/badge.svg)](https://github.com/healthonrails/annolid/actions</a>)
[![Annolid Release](<a class="reference external" href="https://github.com/healthonrails/annolid/workflows/Upload%20Python%20Package/badge.svg)](https://github.com/healthonrails/annolid/actions">https://github.com/healthonrails/annolid/workflows/Upload%20Python%20Package/badge.svg)](https://github.com/healthonrails/annolid/actions</a>)
[![DOI](<a class="reference external" href="https://zenodo.org/badge/290017987.svg)](https://zenodo.org/badge/latestdoi/290017987">https://zenodo.org/badge/290017987.svg)](https://zenodo.org/badge/latestdoi/290017987</a>)</p>
<p>An annotation and instance segmentation based multiple animal tracking and behavior analysis package.</p>
<p>![Multiple Animal Tracking](docs/imgs/mutiple_animal_tracking.png)</p>
<p>Instance segmentations             |  Behavior prediction
:————————-:<a href="#id1"><span class="problematic" id="id2">|</span></a>:————————-:
![](docs/imgs/example_segmentation.png) | ![](docs/imgs/example_vis.png)</p>
<p>[![Mouse behavior analysis with instance segmentation based deep learning networks](<a class="reference external" href="http://img.youtube.com/vi/op3A4_LuVj8/0.jpg)](http://www.youtube.com/watch?v=op3A4_LuVj8">http://img.youtube.com/vi/op3A4_LuVj8/0.jpg)](http://www.youtube.com/watch?v=op3A4_LuVj8</a> “Mouse behavior analysis with instance segmentation based deep learning networks”)</p>
<p>## Installation</p>
<ul class="simple">
<li><p>Clone the code repo and change into the directory</p></li>
</ul>
<p><a href="#id3"><span class="problematic" id="id4">``</span></a><a href="#id5"><span class="problematic" id="id6">`</span></a>bash
git clone –recurse-submodules <a class="reference external" href="https://github.com/healthonrails/annolid.git">https://github.com/healthonrails/annolid.git</a>
cd annolid</p>
<p># install the package
pip install -e .
<code class="docutils literal notranslate"><span class="pre">`</span>
<span class="pre">Note:</span> <span class="pre">if</span> <span class="pre">you</span> <span class="pre">got</span> <span class="pre">this</span> <span class="pre">error:</span>
<span class="pre">`</span></code>
ERROR: Could not find a version that satisfies the requirement decord&gt;=0.4.0
<a href="#id7"><span class="problematic" id="id8">``</span></a>`
, please try to install [ffmpeg](<a class="reference external" href="https://ffmpeg.org/">https://ffmpeg.org/</a>) and then install decord from source as described [here](<a class="reference external" href="https://github.com/dmlc/decord">https://github.com/dmlc/decord</a>).</p>
<p>## Launch annolid user interface based on labelme
<a href="#id9"><span class="problematic" id="id10">``</span></a><a href="#id11"><span class="problematic" id="id12">`</span></a>bash
source activate your_env_name
annolid
#or you can provide a label.txt file as follows.
annolid –labels=/path/to/labels_custom.txt</p>
<p><a href="#id13"><span class="problematic" id="id14">``</span></a>`
![Annolid UI based on labelme](docs/imgs/annolid_ui.png)</p>
<p>If you want to learn more about labelme, please check the following link.</p>
<p>[Read more about annotations](annolid/annotation/labelme.md)</p>
<p>## Extract desired number of frames from a video based on optical flow</p>
<p><code class="docutils literal notranslate"><span class="pre">`bash</span>
<span class="pre">python</span> <span class="pre">annolid/main.py</span> <span class="pre">-v</span> <span class="pre">/path/to/my_video.mp4</span> <span class="pre">--extract_frames=100</span>
<span class="pre">`</span></code>
The above command will extract 100 frames from the provided video and save them to a default folder called extracted_frames in the current annolid repo folder.</p>
<p>Or you can use the GUI as follows.</p>
<p>![Extract frames](docs/imgs/extract_frames_dialog.png)</p>
<p>## Display optical flow while extracting frames with <strong>–show_flow=True</strong>
<code class="docutils literal notranslate"><span class="pre">`bash</span>
<span class="pre">python</span> <span class="pre">annolid/main.py</span> <span class="pre">-v</span> <span class="pre">/path/to/my_video.mp4</span> <span class="pre">--extract_frames=100</span> <span class="pre">--show_flow=True</span>
<span class="pre">`</span></code></p>
<p>## Save all the frames as images
<code class="docutils literal notranslate"><span class="pre">`bash</span>
<span class="pre">python</span> <span class="pre">annolid/main.py</span>&#160; <span class="pre">-v</span> <span class="pre">/path/to/my_video.mp4</span> <span class="pre">--extract_frames=-1</span>
<span class="pre">`</span></code>
## Select frames randomly by reservoir sampling
<code class="docutils literal notranslate"><span class="pre">`bash</span>
<span class="pre">python</span> <span class="pre">annolid/main.py</span>&#160; <span class="pre">-v</span> <span class="pre">/path/to/my_video.mp4</span> <span class="pre">--extract_frames=100</span> <span class="pre">--algo=random</span>
<span class="pre">`</span></code></p>
<p>## Extract all the key frames from a video used by the compression methods
:warning: This method may not work for some videos with certain compression methods.
<code class="docutils literal notranslate"><span class="pre">`bash</span>
<span class="pre">python</span> <span class="pre">main.py</span> <span class="pre">-v</span> <span class="pre">/path/to/my_video.mp4</span> <span class="pre">--algo=keyframes</span> <span class="pre">--extract_frames=-1</span>
<span class="pre">`</span></code></p>
<p>## Threshold based object segmenation
Added track bars for users to select HSV values to
segment ROIs in the provided video.
<code class="docutils literal notranslate"><span class="pre">`bash</span>
<span class="pre">python</span> <span class="pre">annolid/main.py</span> <span class="pre">-v</span> <span class="pre">/path/to/my_video.mp4</span> <span class="pre">--segmentation=threshold</span>
<span class="pre">`</span></code>
![Threshold based segmentation](docs/imgs/threshold_based_segmentation.png)</p>
<p>## Convert WMV format to mp4 format using ffmpeg
<code class="docutils literal notranslate"><span class="pre">`bash</span>
<span class="pre">ffmpeg</span> <span class="pre">-i</span> <span class="pre">/path/to/my_video.wmv</span> <span class="pre">-c:a</span> <span class="pre">aac</span> <span class="pre">/path/to/my_video.mp4</span>
<span class="pre">`</span></code></p>
<p>## Save the extracted frames to a user selected output directory
If not selected, it will save the extracted frames to a folder named with the video name without extension. For example, if the input video path is /path/to/my_video.mp4, the extracted frames will be saved in the folder /path/to/my_video.
The output directory is provided, the extracted frames will be saved /path/to/dest/my_video.
<code class="docutils literal notranslate"><span class="pre">`bash</span>
<span class="pre">cd</span> <span class="pre">annolid</span>
<span class="pre">python</span> <span class="pre">main.py</span> <span class="pre">-v</span> <span class="pre">/path/to/my_video.mp4</span> <span class="pre">--extract_frames=20</span> <span class="pre">--to</span> <span class="pre">/path/to/dest</span> <span class="pre">--algo=uniform</span>
<span class="pre">`</span></code></p>
<p>## How to track multiple objects in the video?
Currently, it just works for person class with pretrained YOLOV3 or YOLOV5 weights.
<code class="docutils literal notranslate"><span class="pre">`bash</span>
<span class="pre">python</span> <span class="pre">annolid/main.py</span> <span class="pre">-v</span> <span class="pre">/path/to/my_video.mp4</span> <span class="pre">--track=YOLOV5</span>
<span class="pre">`</span></code></p>
<p>## How to convert coco annonation format to YOLOV5 format?
The dataset is structured as follows.
<a href="#id15"><span class="problematic" id="id16">``</span></a>`
my_yolo_dataset
├── images
│   ├── train
│   └── val
└── labels</p>
<blockquote>
<div><p>├── train
└── val</p>
</div></blockquote>
<p>data.yaml
<code class="docutils literal notranslate"><span class="pre">`</span>
<span class="pre">`</span></code>
python main.py –coco2yolo=/path/to/my_coco_dataset/annotations.json –to my_yolo_dataset –dataset_type=val
<a href="#id17"><span class="problematic" id="id18">``</span></a>`
## How to train a custom YOLOV5 model?
<a href="#id19"><span class="problematic" id="id20">``</span></a><a href="#id21"><span class="problematic" id="id22">`</span></a>bash
cd annolid/detector
cp -r my_yolo_dataset annolid/detector
cd yolov5
# change nc (number of classes) in the models/yolo5x.yaml, default is 80</p>
<p>python train.py –img 640 –batch 8 –epochs 30 –data ../my_dataset_yolo/data.yaml –cfg ./models/yolov5x.yaml –weights yolov5x.pt –name yolov5x_my_model –cache
<a href="#id23"><span class="problematic" id="id24">``</span></a><a href="#id25"><span class="problematic" id="id26">`</span></a></p>
<p>## How to track objects in a video with the trained model?</p>
<p><code class="docutils literal notranslate"><span class="pre">`bash</span>
<span class="pre">cd</span> <span class="pre">annold</span>
<span class="pre">python</span> <span class="pre">main.py</span> <span class="pre">-v</span> <span class="pre">/path/to/my_video.mp4</span> <span class="pre">--track=YOLOV5</span> <span class="pre">--weights=detector/yolov5/runs/exp5_yolov5x_my_model/weights/best.pt</span>
<span class="pre">`</span></code></p>
<p>## How to convert labelme labeled dataset to COCO format?
:warning: You might need to reinstall annolid because it requires <cite>labelme</cite>
and <cite>pycocotools</cite> now.
<code class="docutils literal notranslate"><span class="pre">`bash</span>
<span class="pre">cd</span> <span class="pre">annold</span>
<span class="pre">python</span> <span class="pre">main.py</span> <span class="pre">--labelme2coco=/path/to/my_labeled_images</span> <span class="pre">--to</span> <span class="pre">/path/to/my_dataset_coco</span> <span class="pre">--labels=/path/to/my_labels.txt</span> <span class="pre">--vis=True</span>
<span class="pre">`</span></code>
If vis is true, it will create an additional visualization folder.
The dataset is structured as follows.
<a href="#id27"><span class="problematic" id="id28">``</span></a>`
../../datasets/mydataset_coco/
├── data.yaml
├── train
│   ├── annotations.json
│   └── JPEGImages
│       ├── 00000444.jpg
└── valid</p>
<blockquote>
<div><p>├── annotations.json
└── JPEGImages</p>
<blockquote>
<div><p>├── 00000443.jpg</p>
</div></blockquote>
</div></blockquote>
<p><a href="#id29"><span class="problematic" id="id30">``</span></a><a href="#id31"><span class="problematic" id="id32">`</span></a></p>
<p>![Visualization](docs/imgs/00002895_7.jpg)</p>
<p>An example mask file</p>
<p>![Masks](docs/imgs/00002895_7_mask.png)</p>
<p>## How to train a YOLACT model with a custom dataset?
Please create a dataset yaml file by using the
annolid/segementation/yolact/configs/mouse_a4_dataset.yaml as
an example.
<code class="docutils literal notranslate"><span class="pre">`</span>
<span class="pre">cd</span> <span class="pre">annolild/segmentation/yolact</span>
<span class="pre">python</span> <span class="pre">train.py</span> <span class="pre">--config=configs/my_custom_dataset.yaml</span>&#160; <span class="pre">--batch_size=8</span>
<span class="pre">`</span></code>
## How to evaluate a video based on a trained model?
<code class="docutils literal notranslate"><span class="pre">`</span>
<span class="pre">cd</span> <span class="pre">annolid/segmentation/yolact</span>
<span class="pre">python</span> <span class="pre">eval.py</span> <span class="pre">--trained_model=weights/yolact_plus_resnet50_xxx_xxx_xxx_interrupt.pth</span> <span class="pre">--score_threshold=0.2</span> <span class="pre">--top_k=4</span> <span class="pre">--video_multiframe=1</span> <span class="pre">--video=my_video.avi:my_result_video.mp4</span> <span class="pre">--mot</span> <span class="pre">--config=configs/my_custom_dataset.yaml</span>
<span class="pre">`</span></code>
Note: the output tracking CSV file and video will be saved to
the folder annolid/segmentation/results.</p>
<p>## Convert the tracking results csv file to Glitter2 csv format
The result csv file named as tracking_results_nix.csv in the folder as provided in –to option.
<code class="docutils literal notranslate"><span class="pre">`</span>
<span class="pre">python</span> <span class="pre">annolid/main.py</span> <span class="pre">-v</span> <span class="pre">/path/to/my_video.mkv</span> <span class="pre">--tracks2glitter</span> <span class="pre">/path/to/tracking_results.csv</span> <span class="pre">--to</span> <span class="pre">/path/to/results_dir/</span>
<span class="pre">`</span></code></p>
<p>## Convert the keypoint annotations to labelme format
e.g. [DeepLabCut Mouse dataset](<a class="reference external" href="https://github.com/DeepLabCut/Primer-MotionCapture/tree/master/mouse_m7s3">https://github.com/DeepLabCut/Primer-MotionCapture/tree/master/mouse_m7s3</a>)</p>
<p><a href="#id33"><span class="problematic" id="id34">``</span></a><a href="#id35"><span class="problematic" id="id36">`</span></a>bash
python annolid/main.py –keypoints2labelme /path/to/mouse_m7s3/  –keypoints /path/to/mouse_m7s3/CollectedData_xxxx.h5</p>
<p><a href="#id37"><span class="problematic" id="id38">``</span></a>`
![Example](docs/imgs/mouse_keypoints.png)</p>
<p># Citing Annolid
If you use Annolid in your research, please use the following BibTeX entry.
<a href="#id39"><span class="problematic" id="id40">``</span></a>`
&#64;misc{yang2020Annolid,</p>
<blockquote>
<div><p>author =       {Chen Yang and Thomas Cleland},
title =        {Annolid},
howpublished = {url{<a class="reference external" href="https://github.com/healthonrails/annolid">https://github.com/healthonrails/annolid</a>}},
year =         {2020}</p>
</div></blockquote>
<div class="section" id="id41">
<h2>}<a class="headerlink" href="#id41" title="Permalink to this headline">¶</a></h2>
</div>
</div>
<div class="section" id="indices-and-tables">
<h1>Indices and tables<a class="headerlink" href="#indices-and-tables" title="Permalink to this headline">¶</a></h1>
<ul class="simple">
<li><p><a class="reference internal" href="genindex.html"><span class="std std-ref">Index</span></a></p></li>
<li><p><a class="reference internal" href="py-modindex.html"><span class="std std-ref">Module Index</span></a></p></li>
<li><p><a class="reference internal" href="search.html"><span class="std std-ref">Search Page</span></a></p></li>
</ul>
</div>


           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2020, Chen Yang.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>